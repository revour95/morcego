<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Morceguinho & Batatas</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:ital@0;1&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000;
    --accent:#c51b1b;
    --text:#fff;
    --muted:#54556b;
    --heart:#e84c4c;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Cinzel',serif;-webkit-tap-highlight-color:transparent}
  #game-wrap{position:relative;width:100vw;height:100vh;overflow:hidden;touch-action:none}
  canvas#game{display:block;background:linear-gradient(180deg,#050505 0%, #0b0b0b 100%);width:100%;height:100%}

  /* HUD */
  #hud{position:absolute;left:12px;top:12px;z-index:40;font-family:'UnifrakturCook',cursive;font-size:26px;color:var(--text);text-shadow:0 2px 0 rgba(0,0,0,.6);}
  #hud .count{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(197,27,27,0.08);border:1px solid rgba(197,27,27,0.14);font-size:18px}

  /* Bat container and sprite */
  .bat-container{
    position:absolute;
    width:56px;
    height:56px;
    transform:translate(-50%,-50%);
    z-index:999; /* bem acima do canvas */
    pointer-events:none;
    left:50%;
    top:50%;
    will-change: transform;
    -webkit-transform:translate(-50%,-50%);
  }
  .bat{
    width:56px;
    height:56px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    pointer-events:none;
    image-rendering: pixelated;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  /* pixel SVG frames: absolute stack */
  .bat svg{
    width:100%;
    height:100%;
    display:block;
    shape-rendering: crispEdges;
    image-rendering: -moz-crisp-edges;
    image-rendering: pixelated;
    position:absolute;
    inset:0;
  }
  /* ensure one frame visible by default, the other hidden — JS will toggle */
  .bat svg.f1{ display:block; opacity:1; }
  .bat svg.f2{ display:none; opacity:0; }

  /* Controls */
  #controls{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:92px;
    z-index:50;
    display:grid;
    grid-template-columns:repeat(3,56px);
    grid-template-rows:repeat(3,56px);
    gap:10px;
    grid-template-areas:
      ". up ."
      "left down right"
      ". . .";
    pointer-events:auto;
  }
  #btn-up{grid-area:up}
  #btn-left{grid-area:left}
  #btn-down{grid-area:down}
  #btn-right{grid-area:right}
  .ctrl-btn{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.03);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.04);user-select:none}
  .ctrl-btn:active{transform:scale(.98)}
  .ctrl-btn .arrow{font-size:22px;color:var(--text);font-weight:700;font-family:'Cinzel',serif;text-shadow:0 2px 0 rgba(0,0,0,.6)}
  #btn-empty, #btn-empty2{display:none}

  /* Overlays */
  .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;max-width:92vw;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.75), rgba(10,0,0,0.6));border:2px solid rgba(197,27,27,0.25);text-align:center}
  .overlay h1{font-family:'UnifrakturCook',cursive;color:var(--accent);font-size:34px;margin:6px 0}
  .overlay p{color:var(--text);font-size:16px;margin:6px 0}
  .btn-primary{margin-top:12px;padding:8px 14px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:700;font-family:'Cinzel',serif}
  .hidden{display:none}

  /* Final overlay */
  #endOverlay {
    position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:1000;
    display:none; align-items:center; justify-content:center; flex-direction:column; padding:24px; box-sizing:border-box;
    background:linear-gradient(180deg, rgba(0,0,0,0.98), rgba(10,0,0,0.97)); text-align:center;
  }
  #endOverlay.show { display:flex; }
  #endOverlay h1{ font-family:'UnifrakturCook',cursive;color:var(--accent);font-size:40px;margin:6px 0;text-shadow:0 6px 18px rgba(0,0,0,0.9) }
  #finalBatHolder{ margin-top:18px; display:flex; align-items:center; justify-content:center; }
  /* row with bat and heart */
  .final-row{ display:flex; align-items:center; justify-content:center; gap:18px; }
  .heart-wrap{ width:120px; height:120px; display:flex; align-items:center; justify-content:center; }
  .heart-svg{ width:100px; height:100px; filter: drop-shadow(0 8px 18px rgba(232,76,76,0.12)); }

  .hidden-during-end { display:none !important; }

  @media (max-width:420px){
    .bat-container{width:50px;height:50px}
    .bat{width:50px;height:50px}
    #controls{bottom:84px; gap:8px}
    .ctrl-btn{width:50px;height:50px}
    #hud{font-size:22px}
    #hud .count{font-size:16px}
    #endOverlay h1{font-size:32px}
    .heart-wrap{ width:84px; height:84px; }
    .heart-svg{ width:68px; height:68px; }
  }

  /* scale bigger in final overlay */
  .bat.still svg{ width:320px; height:320px; position:static; display:inline-block; }
</style>
</head>
<body>
  <div id="game-wrap">
    <canvas id="game"></canvas>

    <div id="hud"><span style="font-family:'UnifrakturCook',cursive">Batatas: </span> <span class="count" id="score">0</span></div>

    <!-- bat sprite container -->
    <div class="bat-container" id="batContainer">
      <div class="bat" id="batSprite" aria-hidden="true">
        <!-- FRAME 1: asas abaixadas (pixel 16x16) -->
        <svg class="frame f1" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
          <!-- left wing top -->
          <rect x="0" y="6" width="1" height="1" fill="#6b6d7b"/>
          <rect x="1" y="5" width="1" height="1" fill="#6b6d7b"/>
          <rect x="2" y="4" width="1" height="1" fill="#6b6d7b"/>
          <rect x="3" y="3" width="1" height="1" fill="#6b6d7b"/>
          <!-- right wing top -->
          <rect x="13" y="3" width="1" height="1" fill="#6b6d7b"/>
          <rect x="14" y="4" width="1" height="1" fill="#6b6d7b"/>
          <rect x="15" y="5" width="1" height="1" fill="#6b6d7b"/>
          <rect x="15" y="7" width="1" height="1" fill="#6b6d7b"/>
          <rect x="0" y="7" width="1" height="1" fill="#6b6d7b"/>
          <!-- wing dark fills -->
          <rect x="1" y="7" width="1" height="1" fill="#111"/>
          <rect x="2" y="7" width="1" height="1" fill="#111"/>
          <rect x="3" y="7" width="1" height="1" fill="#111"/>
          <rect x="4" y="6" width="1" height="1" fill="#111"/>
          <rect x="4" y="8" width="1" height="1" fill="#111"/>
          <rect x="11" y="7" width="1" height="1" fill="#111"/>
          <rect x="12" y="7" width="1" height="1" fill="#111"/>
          <rect x="13" y="7" width="1" height="1" fill="#111"/>
          <rect x="11" y="5" width="1" height="1" fill="#111"/>
          <!-- central body -->
          <rect x="5" y="4" width="6" height="6" fill="#0f0f0f"/>
          <!-- eyes -->
          <rect x="6" y="5" width="1" height="1" fill="#fff"/>
          <rect x="8" y="5" width="1" height="1" fill="#fff"/>
          <!-- little details -->
          <rect x="4" y="5" width="1" height="1" fill="#2a2a2a"/>
          <rect x="11" y="5" width="1" height="1" fill="#2a2a2a"/>
          <rect x="5" y="10" width="1" height="1" fill="#222"/>
          <rect x="10" y="10" width="1" height="1" fill="#222"/>
        </svg>

        <!-- FRAME 2: asas levantadas -->
        <svg class="frame f2" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
          <!-- outline top -->
          <rect x="3" y="1" width="1" height="1" fill="#6b6d7b"/>
          <rect x="4" y="1" width="1" height="1" fill="#6b6d7b"/>
          <rect x="11" y="1" width="1" height="1" fill="#6b6d7b"/>
          <rect x="12" y="1" width="1" height="1" fill="#6b6d7b"/>
          <!-- wing dark top arcs -->
          <rect x="2" y="2" width="1" height="1" fill="#111"/>
          <rect x="1" y="3" width="1" height="1" fill="#111"/>
          <rect x="0" y="4" width="1" height="1" fill="#111"/>
          <rect x="14" y="4" width="1" height="1" fill="#111"/>
          <rect x="15" y="3" width="1" height="1" fill="#111"/>
          <rect x="13" y="2" width="1" height="1" fill="#111"/>
          <!-- central body -->
          <rect x="5" y="6" width="6" height="5" fill="#0f0f0f"/>
          <!-- eyes slightly lower -->
          <rect x="6" y="7" width="1" height="1" fill="#fff"/>
          <rect x="8" y="7" width="1" height="1" fill="#fff"/>
          <!-- extra wing pieces -->
          <rect x="3" y="5" width="1" height="1" fill="#2a2a2a"/>
          <rect x="12" y="5" width="1" height="1" fill="#2a2a2a"/>
          <rect x="2" y="6" width="1" height="1" fill="#111"/>
          <rect x="13" y="6" width="1" height="1" fill="#111"/>
        </svg>
      </div>
    </div>

    <!-- controls -->
    <div id="controls">
      <div id="btn-up" class="ctrl-btn"><div class="arrow">▲</div></div>
      <div id="btn-empty" class="ctrl-btn"></div>
      <div id="btn-right" class="ctrl-btn"><div class="arrow">►</div></div>
      <div id="btn-left" class="ctrl-btn"><div class="arrow">◄</div></div>
      <div id="btn-down" class="ctrl-btn"><div class="arrow">▼</div></div>
      <div id="btn-empty2" class="ctrl-btn"></div>
    </div>

    <!-- start overlay -->
    <div id="overlay" class="overlay">
      <h1>morceguinho</h1>
      <p>Use os botões de setinha (cima / baixo / esquerda / direita) para controlar o morcego.<br>Pegue <strong id="targetLabel">20</strong> batatas-doce.</p>
      <button id="startBtn" class="btn-primary">COMEÇAR</button>
    </div>

    <!-- final overlay -->
    <div id="endOverlay" aria-hidden="true">
      <h1>acredita em mim agora?</h1>
      <div id="finalBatHolder"></div>
    </div>
  </div>

<script>
/* CONFIG */
const TARGET = 20;
const SPAWN_INTERVAL = 800;
const GAME_SPEED = 1;
const POTATO_SIZE = 64;

/* ELEMENTS */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const batContainer = document.getElementById('batContainer');
const batSprite = document.getElementById('batSprite');
const scoreEl = document.getElementById('score');
const overlay = document.getElementById('overlay');
const endOverlay = document.getElementById('endOverlay');
const startBtn = document.getElementById('startBtn');
const targetLabel = document.getElementById('targetLabel');
const finalHolder = document.getElementById('finalBatHolder');
targetLabel.textContent = TARGET;

let W=0,H=0;
function resize(){ 
  // Set canvas CSS size to viewport, and internal buffer to device pixels for crispness
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = vw + 'px';
  canvas.style.height = vh + 'px';
  canvas.width = Math.round(vw * dpr);
  canvas.height = Math.round(vh * dpr);
  W = vw; H = vh;
}
window.addEventListener('resize', ()=>{ resize(); setTimeout(()=>resize(),50); });
resize();

/* player */
const bat = { x: W/2, y: H*0.7, w:56, h:56, speed:320 };
function updateBatPosition(){ 
  // Update the container position (pixel-based)
  batContainer.style.left = bat.x + 'px'; 
  batContainer.style.top  = bat.y + 'px'; 
}
updateBatPosition();

/* controls */
const keys = {up:false,down:false,left:false,right:false};
function bindBtn(id, keyName){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('touchstart', e=>{ e.preventDefault(); keys[keyName]=true; }, {passive:false});
  el.addEventListener('touchend', e=>{ e.preventDefault(); keys[keyName]=false; }, {passive:false});
  el.addEventListener('mousedown', ()=>keys[keyName]=true);
  el.addEventListener('mouseup', ()=>keys[keyName]=false);
  el.addEventListener('mouseleave', ()=>keys[keyName]=false);
}
bindBtn('btn-up','up');
bindBtn('btn-down','down');
bindBtn('btn-left','left');
bindBtn('btn-right','right');

window.addEventListener('keydown', e=>{
  if(e.key.includes('Arrow')) e.preventDefault();
  if(e.key==='ArrowUp') keys.up=true;
  if(e.key==='ArrowDown') keys.down=true;
  if(e.key==='ArrowLeft') keys.left=true;
  if(e.key==='ArrowRight') keys.right=true;
});
window.addEventListener('keyup', e=>{
  if(e.key==='ArrowUp') keys.up=false;
  if(e.key==='ArrowDown') keys.down=false;
  if(e.key==='ArrowLeft') keys.left=false;
  if(e.key==='ArrowRight') keys.right=false;
});

/* potatoes image */
const potatoImg = new Image();
potatoImg.src = 'assets/potato.png';
let potatoImgLoaded = false;
potatoImg.onload = ()=>{ potatoImgLoaded = true; }
potatoImg.onerror = ()=>{ potatoImgLoaded = false; }

/* game state */
let potatoes = [], lastSpawn = 0, score = 0, running = false, lastTime = 0;
function spawnPotato(){ const size = POTATO_SIZE * (0.9 + Math.random()*0.2); potatoes.push({ x: Math.random()*(W-size), y: -size, vy: 120 + Math.random()*120, size }); }

/* JS flap (toggle frames) - reliable on mobile */
(function setupFlap(){
  const f1 = batSprite.querySelector('svg.f1');
  const f2 = batSprite.querySelector('svg.f2');
  if(!f1 || !f2) return;
  // ensure initial visible state
  f1.style.display = 'block';
  f2.style.display = 'none';
  let showFirst = false;
  // toggle at ~380ms to mimic earlier timing
  setInterval(()=>{
    showFirst = !showFirst;
    if(showFirst){
      f1.style.display = 'block';
      f2.style.display = 'none';
      f1.style.opacity = '1';
      f2.style.opacity = '0';
    } else {
      f1.style.display = 'none';
      f2.style.display = 'block';
      f1.style.opacity = '0';
      f2.style.opacity = '1';
    }
  }, 380);
})();

function step(ts){
  if(!running) return;
  if(!lastTime) lastTime = ts;
  const dt = (ts - lastTime)/1000; lastTime = ts;

  const move = bat.speed * dt * GAME_SPEED;
  if(keys.left) bat.x -= move;
  if(keys.right) bat.x += move;
  if(keys.up) bat.y -= move;
  if(keys.down) bat.y += move;
  const controlsSpace = Math.max(120, window.innerHeight * 0.16);
  bat.x = Math.max(bat.w/2, Math.min(W - bat.w/2, bat.x));
  bat.y = Math.max(bat.h/2, Math.min(H - bat.h/2 - controlsSpace, bat.y));
  updateBatPosition();

  if(performance.now() - lastSpawn > SPAWN_INTERVAL){ lastSpawn = performance.now(); spawnPotato(); }

  // draw potatoes
  // scale drawing to devicePixelRatio for crispness
  const dpr = window.devicePixelRatio || 1;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,W,H);
  for(let i=potatoes.length-1;i>=0;i--){
    const p = potatoes[i];
    p.y += p.vy * dt * GAME_SPEED;
    if(potatoImgLoaded){
      ctx.drawImage(potatoImg, p.x, p.y, p.size, p.size);
    } else {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(4, p.size-8, p.size-6, 6);
      ctx.fillStyle = '#d07b30';
      roundRect(ctx, 0, 0, p.size, p.size*0.85, Math.max(6, p.size*0.12), true, false);
      ctx.fillStyle = '#b15d1d';
      ctx.fillRect(p.size*0.18, p.size*0.35, p.size*0.18, p.size*0.08);
      ctx.restore();
    }

    const batBox = { x: bat.x - bat.w/2, y: bat.y - bat.h/2, w: bat.w, h: bat.h };
    const pBox = { x: p.x, y: p.y, w: p.size, h: p.size };
    if(rectIntersect(batBox,pBox)){
      potatoes.splice(i,1);
      score++; scoreEl.textContent = score;
      if(score>=TARGET){ endGame(); return; }
    } else if(p.y > H + 200){
      potatoes.splice(i,1);
    }
  }

  requestAnimationFrame(step);
}

/* helpers */
function rectIntersect(a,b){ return !(a.x > b.x + b.w || a.x + a.w < b.x || a.y > b.y + b.h || a.y + a.h < b.y); }
function roundRect(ctx, x,y,w,h,r, fill, stroke){ if(typeof r==='undefined') r=5; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }

/* start / end */
startBtn.addEventListener('click', ()=>{ overlay.classList.add('hidden'); startGame(); });
function startGame(){ score = 0; scoreEl.textContent = 0; potatoes = []; lastSpawn = performance.now(); running = true; lastTime = 0; document.getElementById('game').style.display = ''; document.getElementById('controls').style.display = ''; document.getElementById('hud').style.display = ''; endOverlay.classList.remove('show'); endOverlay.setAttribute('aria-hidden','true'); bat.x = W/2; bat.y = H*0.7; updateBatPosition(); requestAnimationFrame(step); }

function endGame(){
  running = false;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  potatoes = [];
  document.getElementById('game').style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('hud').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';

  finalHolder.innerHTML = '';
  const spriteClone = batSprite.cloneNode(true);
  spriteClone.classList.add('still');
  // ensure the cloned SVGs scale
  const svgElems = spriteClone.querySelectorAll('svg');
  svgElems.forEach(s => { s.setAttribute('width','320'); s.setAttribute('height','320'); s.style.position = 'static'; s.style.display = 'inline-block'; });

  // create final row with bat + heart
  const finalRow = document.createElement('div');
  finalRow.className = 'final-row';

  // bat wrapper
  const batWrap = document.createElement('div');
  batWrap.style.width = '320px';
  batWrap.style.height = '320px';
  batWrap.style.display = 'flex';
  batWrap.style.alignItems = 'center';
  batWrap.style.justifyContent = 'center';
  batWrap.appendChild(spriteClone);

  // heart wrapper (inline SVG)
  const heartWrap = document.createElement('div');
  heartWrap.className = 'heart-wrap';
  heartWrap.setAttribute('aria-hidden','false');
  const heartSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  heartSvg.setAttribute('viewBox','0 0 24 24');
  heartSvg.setAttribute('class','heart-svg');
  heartSvg.setAttribute('role','img');
  heartSvg.setAttribute('aria-label','coração');
  heartSvg.innerHTML = `
    <defs>
      <filter id="hShadow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="#e84c4c" flood-opacity="0.12"/>
      </filter>
    </defs>
    <path d="M12 21s-7.5-4.8-9.1-7.1C0.9 10.8 3 7 6.7 7c1.9 0 3.1 1.1 3.3 1.3.2-.2 1.5-1.3 3.3-1.3 3.7 0 5.8 3.8 3.8 6.9C19.6 16.2 12 21 12 21z" fill="var(--heart)" filter="url(#hShadow)"/>
  `;
  heartWrap.appendChild(heartSvg);

  // append to final row
  finalRow.appendChild(batWrap);
  finalRow.appendChild(heartWrap);
  finalHolder.appendChild(finalRow);

  endOverlay.classList.add('show');
  endOverlay.setAttribute('aria-hidden','false');
  window.scrollTo(0,0);
}

/* prevent scroll while touching game */
document.getElementById('game-wrap').addEventListener('touchmove', e=>{ e.preventDefault(); }, {passive:false});
(function smooth(){ updateBatPosition(); requestAnimationFrame(smooth); })();
window.addEventListener('load', ()=>{ resize(); bat.x = window.innerWidth/2; bat.y = window.innerHeight*0.7; updateBatPosition(); });
</script>
</body>
</html>
