<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Morceguinho & Batatas</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:ital@0;1&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#000;
    --accent:#c51b1b;
    --text:#fff;
    --muted:#54556b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:'Cinzel',serif}
  #game-wrap{position:relative;width:100vw;height:100vh;overflow:hidden;touch-action:none}
  canvas#game{display:block;background:linear-gradient(180deg,#050505 0%, #0b0b0b 100%);width:100%;height:100%}

  /* HUD */
  #hud{position:absolute;left:12px;top:12px;z-index:40;font-family:'UnifrakturCook',cursive;font-size:20px;color:var(--text);text-shadow:0 2px 0 rgba(0,0,0,.6);}
  #hud .count{display:inline-block;padding:6px 10px;border-radius:8px;background:rgba(200,0,0,0.06);border:1px solid rgba(200,0,0,0.12);}

  /* Bat container e sprite (ajustes para mobile) */
  .bat-container{
    position:absolute;
    width:48px;
    height:48px;
    transform:translate(-50%,-50%);
    z-index:45;
    pointer-events:none;
  }
  /* sprite adaptado: diminuí escala e corrigi offsets */
  .bat{
    width:1px;height:1px;position:relative;
    left:-64px; top:-64px;
    transform:scale(2);
    animation:.6s steps(2) infinite;
    image-rendering: pixelated;
  }
  .bat.still{animation:none}

  /* Controles reorganizados: D-pad em grid, deslocados para cima para não encostar na barra do SO */
  #controls{
    position:absolute;
    left:18px;
    bottom: calc(18px + env(safe-area-inset-bottom));
    z-index:50;
    display:grid;
    grid-template-columns:repeat(3,56px);
    grid-template-rows:repeat(3,56px);
    gap:10px;
    grid-template-areas:
      ". up ."
      "left down right"
      ". . .";
  }
  #btn-up{grid-area:up}
  #btn-left{grid-area:left}
  #btn-down{grid-area:down}
  #btn-right{grid-area:right}

  .ctrl-btn{width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,0.03);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.04);user-select:none}
  .ctrl-btn:active{transform:scale(.98)}
  .ctrl-btn .arrow{font-size:22px;color:var(--text);font-weight:700;font-family:'Cinzel',serif;text-shadow:0 2px 0 rgba(0,0,0,.6)}

  /* Esconde espaços vazios */
  #btn-empty, #btn-empty2 {display:none}

  /* Overlay minimalista */
  .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;max-width:92vw;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.75), rgba(10,0,0,0.6));border:2px solid rgba(197,27,27,0.25);text-align:center}
  .overlay h1{font-family:'UnifrakturCook',cursive;color:var(--accent);font-size:34px;margin:6px 0}
  .overlay p{color:var(--text);font-size:16px;margin:6px 0}
  .btn-primary{margin-top:12px;padding:8px 14px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:700;font-family:'Cinzel',serif}
  .hidden{display:none}

  /* Ajustes responsivos */
  @media (max-width:420px){
    .bat-container{width:44px;height:44px}
    .bat{transform:scale(1.9); left:-60px; top:-60px}
    #controls{left:14px; gap:8px}
    .ctrl-btn{width:52px;height:52px}
  }
</style>
</head>
<body>
  <div id="game-wrap">
    <canvas id="game"></canvas>

    <div id="hud"><span style="font-family:'UnifrakturCook',cursive;font-size:26px">Batatas: </span> <span class="count" id="score">0</span></div>

    <div class="bat-container" id="batContainer"><div class="bat" id="batSprite"></div></div>

    <div id="controls">
      <div id="btn-up" class="ctrl-btn"><div class="arrow">▲</div></div>
      <div id="btn-empty" class="ctrl-btn"></div>
      <div id="btn-right" class="ctrl-btn"><div class="arrow">►</div></div>
      <div id="btn-left" class="ctrl-btn"><div class="arrow">◄</div></div>
      <div id="btn-down" class="ctrl-btn"><div class="arrow">▼</div></div>
      <div id="btn-empty2" class="ctrl-btn"></div>
    </div>

    <div id="overlay" class="overlay">
      <h1>morceguinho</h1>
      <p>Use os botões de setinha (cima / baixo / esquerda / direita) para controlar o morcego.<br>Pegue <strong id="targetLabel">10</strong> batatas-doce.</p>
      <button id="startBtn" class="btn-primary">COMEÇAR</button>
    </div>

    <div id="endOverlay" class="overlay hidden">
      <h1 style="font-size:40px">acredita em mim agora?</h1>
      <div style="margin-top:12px;color:var(--text);font-family:'Cinzel',serif">Você pegou <strong id="finalScore">0</strong> batatas.</div>
      <div id="finalBatHolder" style="margin-top:10px"></div>
      <button id="replayBtn" class="btn-primary">JOGAR DE NOVO</button>
    </div>
  </div>

<script>
/* CONFIG */
const TARGET = 10;
const SPAWN_INTERVAL = 800;
const GAME_SPEED = 1;
const POTATO_SIZE = 64; // você pediu 64x64

/* SETUP */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const batContainer = document.getElementById('batContainer');
const batSprite = document.getElementById('batSprite');
const scoreEl = document.getElementById('score');
const overlay = document.getElementById('overlay');
const endOverlay = document.getElementById('endOverlay');
const startBtn = document.getElementById('startBtn');
const targetLabel = document.getElementById('targetLabel');
const finalScore = document.getElementById('finalScore');
const finalHolder = document.getElementById('finalBatHolder');
targetLabel.textContent = TARGET;

let W=0,H=0;
function resize(){ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
window.addEventListener('resize', ()=>{ resize(); setTimeout(()=>resize(),50); });
resize();

/* PLAYER (morcego) */
const bat = { x: W/2, y: H*0.7, w:48, h:48, speed:300 };
function updateBatPosition(){
  // posicionar o container pelo centro do morcego
  batContainer.style.left = (bat.x) + 'px';
  batContainer.style.top  = (bat.y) + 'px';
}
updateBatPosition();

/* CONTROLES */
const keys = {up:false,down:false,left:false,right:false};
function bindBtn(id, keyName){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('touchstart', e=>{ e.preventDefault(); keys[keyName]=true; }, {passive:false});
  el.addEventListener('touchend', e=>{ e.preventDefault(); keys[keyName]=false; }, {passive:false});
  el.addEventListener('mousedown', ()=>keys[keyName]=true);
  el.addEventListener('mouseup', ()=>keys[keyName]=false);
  el.addEventListener('mouseleave', ()=>keys[keyName]=false);
}
bindBtn('btn-up','up');
bindBtn('btn-down','down');
bindBtn('btn-left','left');
bindBtn('btn-right','right');
window.addEventListener('keydown', e=>{
  if(e.key.includes('Arrow')) e.preventDefault();
  if(e.key==='ArrowUp') keys.up=true;
  if(e.key==='ArrowDown') keys.down=true;
  if(e.key==='ArrowLeft') keys.left=true;
  if(e.key==='ArrowRight') keys.right=true;
});
window.addEventListener('keyup', e=>{
  if(e.key==='ArrowUp') keys.up=false;
  if(e.key==='ArrowDown') keys.down=false;
  if(e.key==='ArrowLeft') keys.left=false;
  if(e.key==='ArrowRight') keys.right=false;
});

/* POTATO IMAGE */
const potatoImg = new Image();
potatoImg.src = 'assets/potato.png';
let potatoImgLoaded = false;
potatoImg.onload = ()=>{ potatoImgLoaded = true; console.log('potato loaded'); }
potatoImg.onerror = ()=>{ potatoImgLoaded = false; console.warn('potato image not found at assets/potato.png'); }

/* ITENS */
let potatoes = [], lastSpawn = 0, score = 0, running = false, lastTime = 0;

function spawnPotato(){
  const size = POTATO_SIZE * (0.9 + Math.random()*0.2); // pequeno variance
  potatoes.push({ x: Math.random()*(W-size), y: -size, vy: 120 + Math.random()*120, size });
}

/* LOOP */
function step(ts){
  if(!running) return;
  if(!lastTime) lastTime = ts;
  const dt = (ts - lastTime)/1000; lastTime = ts;

  // mover morcego
  const move = bat.speed * dt * GAME_SPEED;
  if(keys.left) bat.x -= move;
  if(keys.right) bat.x += move;
  if(keys.up) bat.y -= move;
  if(keys.down) bat.y += move;
  // limites: deixa espaço para controles (aprox 120px)
  const controlsSpace = Math.max(120, window.innerHeight * 0.16);
  bat.x = Math.max(bat.w/2, Math.min(W - bat.w/2, bat.x));
  bat.y = Math.max(bat.h/2, Math.min(H - bat.h/2 - controlsSpace, bat.y));
  updateBatPosition();

  // spawn
  if(performance.now() - lastSpawn > SPAWN_INTERVAL){ lastSpawn = performance.now(); spawnPotato(); }

  // desenha
  ctx.clearRect(0,0,W,H);
  for(let i=potatoes.length-1;i>=0;i--){
    const p = potatoes[i];
    p.y += p.vy * dt * GAME_SPEED;

    if(potatoImgLoaded){
      ctx.drawImage(potatoImg, p.x, p.y, p.size, p.size);
    } else {
      // fallback: batata arredondada com detalhe
      ctx.save();
      ctx.translate(p.x, p.y);
      // sombra
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(4, p.size-8, p.size-6, 6);
      // corpo
      ctx.fillStyle = '#d07b30';
      roundRect(ctx, 0, 0, p.size, p.size*0.85, Math.max(6, p.size*0.12), true, false);
      // detalhe
      ctx.fillStyle = '#b15d1d';
      ctx.fillRect(p.size*0.18, p.size*0.35, p.size*0.18, p.size*0.08);
      ctx.restore();
    }

    // colisão
    const batBox = { x: bat.x - bat.w/2, y: bat.y - bat.h/2, w: bat.w, h: bat.h };
    const pBox = { x: p.x, y: p.y, w: p.size, h: p.size };
    if(rectIntersect(batBox,pBox)){
      potatoes.splice(i,1);
      score++; scoreEl.textContent = score;
      if(score>=TARGET){ endGame(); return; }
    } else if(p.y > H + 200){
      potatoes.splice(i,1);
    }
  }

  requestAnimationFrame(step);
}

function rectIntersect(a,b){
  return !(a.x > b.x + b.w || a.x + a.w < b.x || a.y > b.y + b.h || a.y + a.h < b.y);
}
function roundRect(ctx, x,y,w,h,r, fill, stroke){
  if(typeof r==='undefined') r=5;
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* START / END */
startBtn.addEventListener('click', ()=>{ overlay.classList.add('hidden'); startGame(); });
document.getElementById('replayBtn')?.addEventListener('click', ()=>{ endOverlay.classList.add('hidden'); resetGame(); startGame(); });

function startGame(){
  score = 0; scoreEl.textContent = 0; potatoes = []; lastSpawn = performance.now(); running = true; lastTime = 0;
  // centraliza morcego
  bat.x = W/2; bat.y = H*0.7; updateBatPosition();
  requestAnimationFrame(step);
}
function resetGame(){
  score = 0; scoreEl.textContent = 0; potatoes = [];
  bat.x = W/2; bat.y = H*0.7; updateBatPosition();
}
function endGame(){
  running = false;
  finalScore.textContent = score;
  finalHolder.innerHTML = '';
  // clona e pausa sprite
  const clone = batSprite.cloneNode(true);
  clone.classList.add('still');
  const wrap = document.createElement('div'); wrap.style.marginTop='12px'; wrap.appendChild(clone);
  finalHolder.appendChild(wrap);
  endOverlay.classList.remove('hidden');
}

/* impede scroll no jogo */
document.getElementById('game-wrap').addEventListener('touchmove', e=>{ e.preventDefault(); }, {passive:false});

/* loop leve para atualizar posição do container se necessário */
(function smooth(){ updateBatPosition(); requestAnimationFrame(smooth); })();
</script>
</body>
</html>
